<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>个人主页</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/user/homepage.css}"> <!-- 引入个人主页样式 -->
    <link rel="stylesheet" th:href="@{/css/style.css}"> <!-- 引入公共样式 -->
    <script th:src="@{/js/common/utils.js}"></script> <!-- 引入公共工具 -->
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container">
    <div class="greeting" id="greetingText">你好，游客</div>

    <div class="userinfo" id="userInfo">
        <p>账号：-</p>
        <p>登录时间：-</p>
    </div>

    <div class="actions">
        <button class="btn btn-dark w-100" onclick="alert('暂未开放')">修改密码</button>
        <button class="btn btn-danger w-100" onclick="logout()">退出登录</button>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script th:inline="javascript">

    // 退出登录按钮点击事件
    function logout() {
        fetchWithToken("user/logout", {
            method: "POST",
        })
        .then(response => {
            console.log("登出响应：", response);
            return response.code; // 这里返回 Promise
        })
        .then(code => {
            console.log("登出响应：", code);
            if (code === 0) {
                localStorage.removeItem("accessToken"); // 登出成功后移除 accessToken
                window.location.href = contextStatic + "index"; // 跳转到登录页面
            } else {
                throw new Error("登出请求状态异常");
            }
        })
        .catch(error => {
            alert("登出失败：" + error.message);
        });
    }

    // 加载用户信息
    window.onload = function () {
        fetchWithToken("user/info")
            .then(response => {
                return response.data;
            })
            .then(data => {
                if(!data || !data.username) {
                    throw new Error("用户信息不完整");
                }
                const greeting = getGreeting();
                document.getElementById("greetingText").textContent = `${greeting}好，${data.username}`;
                document.getElementById("userInfo").innerHTML = `
                    <p>账号：${data.account}</p>
                    <p>用户名：${data.username}</p>
                `;
            }).catch(error => {
            alert("获取用户信息失败：" + error.message);
            console.error('获取用户信息失败：', error.message);
            window.location.href = contextStatic + "auth/login";
        });
    };

    // 获取问候语
    function getGreeting() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return "上午";
        if (hour >= 12 && hour < 18) return "下午";
        return "晚上";
    }

</script>
</body>
</html>