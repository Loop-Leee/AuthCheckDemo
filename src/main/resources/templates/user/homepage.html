<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸»é¡µ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/user/homepage.css}"> <!-- å¼•å…¥ä¸ªäººä¸»é¡µæ ·å¼ -->
    <link rel="stylesheet" th:href="@{/css/style.css}"> <!-- å¼•å…¥å…¬å…±æ ·å¼ -->
    <script th:src="@{/js/common/utils.js}"></script> <!-- å¼•å…¥å…¬å…±å·¥å…· -->
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container d-flex flex-column">
    <div class="greeting fade-in" id="greetingText">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
    </div>

    <div class="userinfo fade-in" id="userInfo">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
    </div>

    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
    <div class="actions sticky-footer fade-in">
        <p class="greeting" id="dailyQuote" onclick="getDailyQuote()">~~~</p>
        <button class="btn btn-dark w-100 mb-2" id="boringButton" onclick="boringFeedback()">
            æ— èŠå¯ä»¥ç‚¹æˆ‘,è™½ç„¶æˆ‘æ²¡ä»€ä¹ˆç”¨
        </button>
        <button class="btn btn-danger w-100" onclick="handleLogout()">
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
            é€€å‡ºç™»å½•
        </button>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        getDailyQuote();
        loadUserInfo();
    });

    // è·å–æ¯æ—¥é—®å€™è¯­
    function getDailyQuote() {
        const quotes = [
            "ã€Œæ¬¢è¿å›æ¥ï¼Œå’–å•¡å·²è‡ªåŠ¨ç»­æ¯~ã€",
            "æ£€æµ‹åˆ°å¾®ç¬‘è¡¨æƒ…ï¼ä»Šæ—¥å¿«ä¹æŒ‡æ•°+10%âœ¨ã€",
            "ã€Œç”µé‡æ»¡æ ¼ï¼è¿™æ¬¡è¦æ¢ç´¢å“ªä¸ªæ–°å®‡å®™ï¼Ÿã€",
            "ã€Œä½ çš„ä¸“å±BGMå·²å“èµ·ï¼šğŸµ__æ¬¢è¿å…‰ä¸´__ğŸµã€",
            "ã€Œç´§æ€¥æ’­æŠ¥ï¼šæ‚¨æœ‰ã€æœªæ‹†å°çš„å¥½å¿ƒæƒ…ã€‘å¾…é¢†å–ï¼ã€",
            "ã€Œç©ºæ°”æ²™å‘å·²å……æ°”ï¼Œè¯·é€‰æ‹©é™è½å§¿åŠ¿â€”â€”ğŸ˜Œ/ğŸ¤¸/ğŸ›Œã€",
            "ã€Œæ¸©é¦¨æç¤ºï¼šæœ¬ç•Œé¢æ”¯æŒè„‘ç”µæ³¢è¾“å…¥ã€",
            "ã€Œç”µé‡å·²å……æ»¡ï¼Œå¥½å¥‡å¿ƒå……åˆ°200%äº†å—ï¼ŸğŸ”‹ã€"
        ];

        const dailyQuote = document.getElementById('dailyQuote');
        const randomIndex = Math.floor(Math.random() * quotes.length);
        dailyQuote.textContent = quotes[randomIndex];
    }

    // æ— èŠæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function boringFeedback() {
        const button = document.getElementById('boringButton');
        button.textContent = 'ä½ å¥½æ— èŠ';
        button.classList.add('btn-secondary');
        button.classList.remove('btn-dark');
    }

    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    async function loadUserInfo() {
        try {
            const response = await utils.fetchWithToken('user/info');
            
            if (response.code === 0 && response.data) {
                const data = response.data;
                if (!data.account) {
                    throw new Error('ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´');
                }
                
                const greeting = utils.getGreeting();
                document.getElementById('greetingText').innerHTML = `${greeting}å¥½ï¼Œ${data.username}`;
                document.getElementById('userInfo').innerHTML = `
                    <div class="card shadow">
                        <div class="card-body">
                            <h5 class="card-title">ä¸ªäººä¿¡æ¯</h5>
                            <p class="card-text">è´¦å·ï¼š${data.account}</p>
                            <p class="card-text">é‚®ç®±ï¼š${data.email || 'æœªè®¾ç½®'}</p>
                            <p class="card-text">ç”µè¯ï¼š${data.phone || 'æœªè®¾ç½®'}</p>
                        </div>
                    </div>
                `;
            } else {
                throw new Error(response.message || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
            }
        } catch (error) {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            utils.showError('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + error.message, document.querySelector('.container'));
            setTimeout(() => {
                window.location.href = contextStatic + 'auth/login';
            }, 2000);
        }
    }

    // é€€å‡ºç™»å½•
    async function handleLogout() {
        const logoutButton = document.querySelector('.btn-danger');
        const spinner = logoutButton.querySelector('.spinner-border');
        
        try {
            logoutButton.disabled = true;
            spinner.classList.remove('d-none');
            
            const response = await utils.fetchWithToken('user/logout', {
                method: 'POST'
            });
            
            if (response.code === 0) {
                localStorage.removeItem('accessToken');
                utils.showSuccess('é€€å‡ºç™»å½•æˆåŠŸ', document.querySelector('.container'));
                setTimeout(() => {
                    window.location.href = contextStatic + 'index';
                }, 1000);
            } else {
                throw new Error(response.message || 'é€€å‡ºç™»å½•å¤±è´¥');
            }
        } catch (error) {
            console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
            utils.showError('é€€å‡ºç™»å½•å¤±è´¥: ' + error.message, document.querySelector('.container'));
        } finally {
            logoutButton.disabled = false;
            spinner.classList.add('d-none');
        }
    }
</script>
</body>
</html>