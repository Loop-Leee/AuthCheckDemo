<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ä¸ªäººä¸»é¡µ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/user/homepage.css}"> <!-- å¼•å…¥ä¸ªäººä¸»é¡µæ ·å¼ -->
    <link rel="stylesheet" th:href="@{/css/style.css}"> <!-- å¼•å…¥å…¬å…±æ ·å¼ -->
    <script th:src="@{/js/common/utils.js}"></script> <!-- å¼•å…¥å…¬å…±å·¥å…· -->
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<div class="container d-flex flex-column">
    <div class="greeting" id="greetingText">ä½ å¥½ï¼Œæ¸¸å®¢</div>

    <div class="userinfo" id="userInfo">
        <p>è¯·è¿›è¡Œç™»å½•è®¤è¯</p>
    </div>

    <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
    <div class="actions sticky-footer">
        <p class="greeting" id="dailyQuote" onclick="getDailyQuote()">~~~</p>
        <button class="btn btn-dark w-100" id="boringButton" onclick="boringFeedback()">æ— èŠå¯ä»¥ç‚¹æˆ‘,è™½ç„¶æˆ‘æ²¡ä»€ä¹ˆç”¨</button>
        <button class="btn btn-danger w-100" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
</div>

<div th:replace="fragments/footer :: footer"></div>

<script th:inline="javascript">

    document.addEventListener("DOMContentLoaded", function () {
        getDailyQuote();
    });

    function getDailyQuote() {
        const quotes = [
            "ã€Œæ¬¢è¿å›æ¥ï¼Œå’–å•¡å·²è‡ªåŠ¨ç»­æ¯~ã€",
            "æ£€æµ‹åˆ°å¾®ç¬‘è¡¨æƒ…ï¼ä»Šæ—¥å¿«ä¹æŒ‡æ•°+10%âœ¨ã€",
            "ã€Œç”µé‡æ»¡æ ¼ï¼è¿™æ¬¡è¦æ¢ç´¢å“ªä¸ªæ–°å®‡å®™ï¼Ÿã€",
            "ã€Œä½ çš„ä¸“å±BGMå·²å“èµ·ï¼šğŸµ__æ¬¢è¿å…‰ä¸´__ğŸµã€",
            "ã€Œç´§æ€¥æ’­æŠ¥ï¼šæ‚¨æœ‰ã€æœªæ‹†å°çš„å¥½å¿ƒæƒ…ã€‘å¾…é¢†å–ï¼ã€",
            "ã€Œç©ºæ°”æ²™å‘å·²å……æ°”ï¼Œè¯·é€‰æ‹©é™è½å§¿åŠ¿â€”â€”ğŸ˜Œ/ğŸ¤¸/ğŸ›Œã€",
            "ã€Œæ¸©é¦¨æç¤ºï¼šæœ¬ç•Œé¢æ”¯æŒè„‘ç”µæ³¢è¾“å…¥ã€",
            "ã€Œç”µé‡å·²å……æ»¡ï¼Œå¥½å¥‡å¿ƒå……åˆ°200%äº†å—ï¼ŸğŸ”‹ã€"
        ];

        const dailyQuote = document.getElementById('dailyQuote');
        const randomIndex = Math.floor(Math.random() * quotes.length);
        dailyQuote.textContent = quotes[randomIndex];
    }

    // ä¿®æ”¹å¯†ç æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function boringFeedback() {
        // å°†æŒ‰é”®ä¸Šçš„æ–‡å­—æ›¿æ¢ä¸º "ä½ å¥½æ— èŠ"
        document.getElementById("boringButton").textContent = "ä½ å¥½æ— èŠ";
    }

    // é€€å‡ºç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    function logout() {
        fetchWithToken("user/logout", {
            method: "POST",
        })
        .then(response => {
            console.log("ç™»å‡ºå“åº”ï¼š", response);
            return response.code; // è¿™é‡Œè¿”å› Promise
        })
        .then(code => {
            console.log("ç™»å‡ºå“åº”ï¼š", code);
            if (code === 0) {
                localStorage.removeItem("accessToken"); // ç™»å‡ºæˆåŠŸåç§»é™¤ accessToken
                window.location.href = contextStatic + "index"; // è·³è½¬åˆ°ç™»å½•é¡µé¢
            } else {
                throw new Error("ç™»å‡ºè¯·æ±‚çŠ¶æ€å¼‚å¸¸");
            }
        })
        .catch(error => {
            alert("ç™»å‡ºå¤±è´¥ï¼š" + error.message);
        });
    }

    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    window.onload = function () {
        fetchWithToken("user/info")
            .then(response => {
                return response.data;
            })
            .then(data => {
                if(!data || !data.account) {
                    throw new Error("ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´");
                }
                const greeting = getGreeting();
                document.getElementById("greetingText").textContent = `${greeting}å¥½ï¼Œ${data.username}`;
                document.getElementById("userInfo").innerHTML = `
                    <p>è´¦å·ï¼š${data.account}</p>
                    <p>é‚®ç®±ï¼š${data.email}</p>
                `;
            }).catch(error => {
            alert("è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š" + error.message);
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š', error.message);
            window.location.href = contextStatic + "auth/login";
        });
    };

    // è·å–é—®å€™è¯­
    function getGreeting() {
        const hour = new Date().getHours();
        if (hour >= 5 && hour < 12) return "ä¸Šåˆ";
        if (hour >= 12 && hour < 18) return "ä¸‹åˆ";
        return "æ™šä¸Š";
    }

</script>
</body>
</html>